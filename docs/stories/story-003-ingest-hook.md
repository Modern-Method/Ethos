# Story 003: ethos-ingest Hook (TypeScript)

**Status:** In Progress  
**Owner:** Forge  
**Epic:** Animus Core  
**Priority:** High  

## üéØ Goal
Implement the TypeScript ingestion hook (`ethos-ingest`) that listens for OpenClaw `message:received` and `message:sent` events and pipes them into the Ethos Unix socket (`/tmp/ethos.sock`).

This is the **primary input vector** for the Ethos memory system. If this fails, the memory engine is deaf.

## üì¶ Scope
- **Directory**: `ethos-ingest/` (create if missing, `npm init` logic)
- **Language**: TypeScript (target ES2022)
- **Protocol**: MessagePack over Unix Domain Socket
  - 4-byte Little Endian length prefix (u32)
  - Payload: MessagePack-serialized `EthosRequest`
- **Events**:
  - `message:received` -> `EthosRequest::Ingest { content, source: "user", ... }`
  - `message:sent` -> `EthosRequest::Ingest { content, source: "assistant", ... }`
- **Resilience**:
  - Connect on startup.
  - If connection fails, log error and retry with exponential backoff (up to 1min max).
  - **Zero Blocking**: Never block the main agent loop. Fail open (drop messages if socket dead).

## üß™ Acceptance Criteria (TDD Mandatory)
1.  **Integration Test (Red-Green)**:
    - Mock OpenClaw event emitter.
    - Mock Unix socket server (net.createServer).
    - **Test:** Emit event -> Verify socket receives correct framing (4-byte LE + payload).
    - **Status:** Must pass.
2.  **Framing Correctness**:
    - Verify Little Endian length prefix (crucial - Story 002 fixed server side, client MUST match).
3.  **Resilience Test**:
    - Kill mock socket server.
    - Emit event (should log error, not crash).
    - Restart socket server.
    - Emit event (should reconnect and deliver).
4.  **Coverage**: >90% (using `nyc` or `c8` for TS coverage).
5.  **Runbook**: `docs/runbooks/ethos-ingest.md` created.
6.  **Security**: Input sanitization (no shell injection from message content).

## üõ†Ô∏è Implementation Plan (BMAD Method)
1.  **Setup**: `npm init`, install `msgpack5`, `net` (node built-in), `typescript`.
2.  **Test Harness**: Create `tests/integration.test.ts`.
3.  **Red**: Write failing test for socket connection + framing.
4.  **Green**: Implement `EthosClient` class with `connect()`, `send()`, and `framing`.
5.  **Refactor**: Clean up, add retry logic.
6.  **Hook Logic**: detailed `index.ts` that binds to OpenClaw events.
7.  **Runbook**: Document operations.

---
*Generated by Neko for Forge.*
